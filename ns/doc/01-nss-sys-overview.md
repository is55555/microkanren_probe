# 01-nss-sys-overview.md

## 📦 NSS Preprocessor System Overview

This document provides a high-level view of the NSS system architecture and flow. It describes how `.nss` files are transformed into `.scm` files through namespace-aware symbol mangling and environment scoping.

Goals:

- Core goals: namespace scoping, symbol mangling, optional inlining
- Structured, nested namespace handling (C++-like scoping).
- Inline sub-namespaces with outer visibility.
- Non-intrusive to existing Scheme compilers/interpreters.
- Widely compatible with R5RS/R7RS - Chez Scheme and CHICKEN used for reference.
- Customisable separator for mangled names.
---

## 🔁 Transformation Pipeline

The preprocessor operates in the following stages:

1. **Parse**
   - Reads all top-level S-expressions from the `.nss` source file.

2. **Process**
   - Each form is passed to `process-form`, which dispatches it based on its syntactic type:
     - Namespace forms: `(ns ...)`, `(ns-inline ...)`
     - Definitions: `(define x ...)` or `(define (f args) ...)`
     - Configuration forms: `(ns-set 'separator "..." )`
     - Others: Passed through unchanged

3. **Rewrite**
   - Expression subtrees (like function bodies) are rewritten to apply symbol mangling rules and maintain lexical scoping.

4. **Output**
   - The processed forms are written to an output `.scm` file with a warning header.

---

## 🧱 Core Subsystems

Each transformation stage is backed by modular subsystems:

| Subsystem          | Description                                     | Doc Reference                         |
|--------------------|--------------------------------------------------|----------------------------------------|
| Environment Stack  | Tracks lexical bindings for rewrite visibility   | `02-01-nss-environment-management.md` |
| Namespace Stack    | Tracks current nested namespace during traversal | `02-02-nss-namespace-stack-and-mangling.md` |
| Namespace Forms    | Handles `ns` and `ns-inline`                     | `02-03-nss-namespace-handling.md`     |
| Rewriting Engine   | Rewrites subexpressions with correct bindings    | `02-04-nss-rewrite-subsystem.md`      |
| Error Handling     | Guards against malformed forms                   | `02-05-nss-error-handling.md`         |
| CLI Entrypoint     | Script interface for batch processing `.nss`     | `02-06-nss-cli-entrypoint.md`         |

---

## 🔓 CLI Entrypoint (Summary)

See `02-06-nss-cli-entrypoint.md` for full details.

```bash
chezscheme --script nss-cli.scm input.nss output.scm
```

This launches:
- File parsing
- Form dispatch
- Namespace tracking and mangling
- Code generation

A header comment is added to the output file warning that it is autogenerated.

---

## 🧪 Testing Strategy

Each subsystem is accompanied by standalone test scripts in the `test/` directory:
- `test/test-env-stack.scm`
- `test/test-rewrite.scm`
- `test/test-rewrite2.scm`
- `test/test-rewrite-extra-let-bindings.scm`

Tests are run using:
```bash
chezscheme --script test/<file>.scm
```

---

## 📁 Project Structure

```plaintext
.
├── nss-lib.scm               ; core transformation engine
├── nss-cli.scm               ; CLI entrypoint
├── nss-env-nsstack.scm       ; env and namespace stack utilities
├── test/                     ; test harnesses
├── *.nss                     ; input files
├── *.scm                     ; output files (generated)
└── docs/                     ; documentation folder
```

---

This document describes the architecture. For implementation details, refer to the linked subsystem files above.
